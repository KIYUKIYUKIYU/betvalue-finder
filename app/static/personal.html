<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BetValue Finder - Personal Edition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'JetBrains Mono', 'Consolas', monospace;
            background: #0d1117;
            color: #c9d1d9;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #1f2937, #0f172a);
            border-radius: 12px;
            border: 1px solid #30363d;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #2563eb, #10b981);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: #8b949e;
            font-size: 1.1rem;
        }

        .form-section {
            background: #161b22;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #30363d;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .form-section h2 {
            margin-bottom: 15px;
            color: #f0f6fc;
            font-size: 1.3rem;
            border-bottom: 1px solid #21262d;
            padding-bottom: 8px;
        }

        textarea {
            width: 100%;
            height: 180px;
            background: #0d1117;
            color: #c9d1d9;
            border: 1px solid #30363d;
            padding: 15px;
            font-family: inherit;
            border-radius: 6px;
            resize: vertical;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }

        textarea:focus {
            outline: none;
            border-color: #1f6feb;
            box-shadow: 0 0 0 2px rgba(31, 111, 235, 0.3);
        }

        .button-group {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            background: #238636;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        button:hover {
            background: #2ea043;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(46, 160, 67, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #6e7681;
        }

        .btn-secondary:hover {
            background: #7c8287;
        }

        .btn-info {
            background: #1f6feb;
        }

        .btn-info:hover {
            background: #4184f3;
        }

        .results {
            margin-top: 20px;
        }

        .results-summary {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .results-summary h3 {
            color: #f0f6fc;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }

        .game-card {
            background: #161b22;
            border: 1px solid #30363d;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .game-card:hover {
            border-color: #1f6feb;
            box-shadow: 0 4px 12px rgba(31, 111, 235, 0.2);
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .game-teams {
            font-size: 1.2rem;
            font-weight: bold;
            color: #f0f6fc;
        }

        .vs {
            color: #8b949e;
            margin: 0 10px;
            font-weight: normal;
        }

        .sport-badge {
            background: #1f6feb;
            color: white;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .game-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .detail-label {
            color: #8b949e;
            font-size: 13px;
        }

        .detail-value {
            font-weight: bold;
            color: #f0f6fc;
        }

        .ev-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #0d1117;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .ev-value {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
            font-weight: bold;
        }

        .ev-positive {
            color: #2ea043;
        }

        .ev-negative {
            color: #f85149;
        }

        .ev-neutral {
            color: #8b949e;
        }

        .verdict {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }

        .verdict-strong {
            background: rgba(247, 144, 9, 0.2);
            color: #f79000;
            border: 1px solid #f79000;
        }

        .verdict-bet {
            background: rgba(46, 160, 67, 0.2);
            color: #2ea043;
            border: 1px solid #2ea043;
        }

        .verdict-consider {
            background: rgba(31, 111, 235, 0.2);
            color: #4184f3;
            border: 1px solid #4184f3;
        }

        .verdict-avoid {
            background: rgba(248, 81, 73, 0.2);
            color: #f85149;
            border: 1px solid #f85149;
        }

        .verdict-neutral {
            background: rgba(139, 148, 158, 0.2);
            color: #8b949e;
            border: 1px solid #8b949e;
        }

        .confidence-section {
            margin-bottom: 15px;
        }

        .confidence-bar {
            width: 100%;
            height: 6px;
            background: #21262d;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #f85149, #f79000, #2ea043);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .confidence-text {
            font-size: 12px;
            color: #8b949e;
        }

        .json-view {
            background: #0d1117;
            border: 1px solid #30363d;
            padding: 15px;
            border-radius: 6px;
            font-size: 11px;
            overflow-x: auto;
            white-space: pre-wrap;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .debug-info {
            margin-top: 15px;
            color: #8b949e;
            border-top: 1px solid #21262d;
            padding-top: 15px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #8b949e;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #30363d;
            border-top-color: #1f6feb;
            border-radius: 50%;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error {
            color: #f85149;
            background: rgba(248, 81, 73, 0.1);
            padding: 15px;
            border-radius: 6px;
            border: 1px solid rgba(248, 81, 73, 0.3);
            margin: 15px 0;
        }

        .api-id {
            font-size: 11px;
            color: #6e7681;
            margin-top: 10px;
            font-family: 'JetBrains Mono', monospace;
        }

        .shortcut-info {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #161b22;
            border: 1px solid #30363d;
            padding: 10px;
            border-radius: 6px;
            font-size: 11px;
            color: #8b949e;
            z-index: 1000;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .game-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .ev-section {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .results-summary {
                flex-direction: column;
                align-items: flex-start;
            }

            .shortcut-info {
                display: none;
            }
        }

        /* 設定セクション */
        .settings-section {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .settings-section h3 {
            margin-bottom: 15px;
            color: #f0f6fc;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }

        .setting-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .setting-item label {
            font-size: 0.9rem;
            color: #8b949e;
            font-weight: 500;
        }

        .setting-item input, .setting-item select {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 8px 12px;
            color: #c9d1d9;
            font-family: inherit;
        }

        .setting-item input:focus, .setting-item select:focus {
            outline: none;
            border-color: #1f6feb;
            box-shadow: 0 0 0 3px rgba(31, 111, 235, 0.3);
        }

        /* プログレスバー */
        .progress-section {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #21262d;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #1f6feb, #10b981);
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-stages {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: #8b949e;
            margin-bottom: 10px;
        }

        .stage-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stage-item.active {
            color: #1f6feb;
        }

        .stage-item.completed {
            color: #10b981;
        }

        .progress-details {
            font-size: 0.9rem;
            color: #8b949e;
            text-align: center;
        }

        /* 双方向ベッティング分析スタイル */
        .betting-analysis {
            margin-top: 15px;
        }

        .team-betting-section {
            border: 1px solid #30363d;
            transition: all 0.2s ease;
        }

        .team-betting-section:hover {
            border-color: #1f6feb;
            box-shadow: 0 2px 8px rgba(31, 111, 235, 0.15);
        }

        .odds-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 8px;
            background: #161b22;
            border-radius: 4px;
            border: 1px solid #21262d;
        }

        @media (max-width: 768px) {
            .settings-grid {
                grid-template-columns: 1fr;
            }

            .progress-stages {
                flex-wrap: wrap;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>🎯 BetValue Finder</h1>
            <p>Personal Edition - 開発者・友人向け無制限アクセス版</p>
        </header>

        <!-- 設定セクション -->
        <section class="settings-section">
            <h3>⚙️ 分析設定</h3>
            <div class="settings-grid">
                <div class="setting-item">
                    <label for="jpOdds">日本式配当倍率</label>
                    <select id="jpOdds">
                        <option value="1.85">1.85倍</option>
                        <option value="1.9" selected>1.9倍 (標準)</option>
                        <option value="1.95">1.95倍</option>
                        <option value="2.0">2.0倍</option>
                    </select>
                </div>
                <div class="setting-item">
                    <label for="rakeback">レーキバック率 (%)</label>
                    <select id="rakeback">
                        <option value="0.0" selected>0.0% (デフォルト)</option>
                        <option value="0.005">0.5%</option>
                        <option value="0.01">1.0%</option>
                        <option value="0.015">1.5%</option>
                        <option value="0.02">2.0%</option>
                        <option value="0.025">2.5%</option>
                        <option value="0.03">3.0% (最大)</option>
                    </select>
                </div>
            </div>
            <div style="font-size: 0.85rem; color: #8b949e; margin-top: 10px;">
                💡 レーキバック効果: 最終EV = 基本EV + (レーキバック率 × 日本式配当) × 100
            </div>
        </section>

        <!-- プログレスセクション -->
        <section id="progressSection" class="progress-section">
            <h3>🔄 Pipeline Orchestrator で分析中...</h3>
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>
            <div class="progress-stages">
                <div class="stage-item" id="stage-parsing">
                    <span>🔍</span>
                    <span>パース中...</span>
                </div>
                <div class="stage-item" id="stage-api">
                    <span>🌐</span>
                    <span>API取得中...</span>
                </div>
                <div class="stage-item" id="stage-matching">
                    <span>🎯</span>
                    <span>マッチング中...</span>
                </div>
                <div class="stage-item" id="stage-odds">
                    <span>💰</span>
                    <span>オッズ取得中...</span>
                </div>
                <div class="stage-item" id="stage-ev">
                    <span>🧮</span>
                    <span>EV計算中...</span>
                </div>
                <div class="stage-item" id="stage-final">
                    <span>📋</span>
                    <span>最終化中...</span>
                </div>
            </div>
            <div id="progressDetails" class="progress-details">
                分析を準備しています...
            </div>
        </section>

        <section class="form-section">
            <h2>📝 ベッティング分析</h2>
            <textarea
                id="bettingText"
                placeholder="ベッティング情報を貼り付けてください...

例:
[ＭＬＢ] ヤンキース<2.0> ホワイトソックス
[ＭＬＢ] ドジャース<1.5> パドレス
[ＭＬＢ] フィリーズ<1半8> マーリンズ

複雑なハンディキャップフォーマット対応:
• 0半2 → 0.75変換
• 0/7 → 0.7変換
• 1半8 → 1.75変換"></textarea>

            <div class="button-group">
                <button onclick="analyze()">
                    <span>🔍</span> 分析実行
                </button>
                <button onclick="clearAll()" class="btn-secondary">
                    <span>🗑️</span> クリア
                </button>
                <button onclick="toggleDebug()" class="btn-info">
                    <span>🔧</span> <span id="debugButtonText">デバッグ表示ON</span>
                </button>
                <button onclick="loadSample()" class="btn-secondary">
                    <span>📋</span> サンプルデータ
                </button>
            </div>
        </section>

        <div id="results" style="display: none;"></div>
    </div>

    <div class="shortcut-info">
        💡 <strong>Ctrl+Enter</strong>で分析実行
    </div>

    <!-- エラートラッキングシステム -->
    <script src="./js/error_tracking.js"></script>

    <script>
        let debugMode = false;

        const sampleData = `[ＭＬＢ] ヤンキース<2.0> ホワイトソックス
[ＭＬＢ] ドジャース<1.5> パドレス
[ＭＬＢ] フィリーズ<1半8> マーリンズ`;

        async function analyze() {
            const text = document.getElementById('bettingText').value.trim();
            if (!text) {
                alert('⚠️ テキストを入力してください');
                return;
            }

            // 設定値を取得
            const jpOdds = parseFloat(document.getElementById('jpOdds').value);
            const rakeback = parseFloat(document.getElementById('rakeback').value);

            // プログレスバーを表示
            const progressSection = document.getElementById('progressSection');
            const resultsDiv = document.getElementById('results');

            progressSection.style.display = 'block';
            resultsDiv.style.display = 'none';

            // プログレスバーのリセット
            resetProgressBar();

            // スムーズスクロール
            progressSection.scrollIntoView({ behavior: 'smooth' });

            try {
                const startTime = Date.now();

                // エラートラッキングに分析開始を記録
                if (window.BetValueErrorTracker) {
                    window.BetValueErrorTracker.logEvent('analysis_started', {
                        text_length: text.length,
                        jp_odds: jpOdds,
                        rakeback: rakeback,
                        timestamp: new Date().toISOString()
                    });
                }

                // プログレスバーのシミュレーション開始
                simulateProgress();

                const response = await fetch('/analyze_paste', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        paste_text: text,
                        sport_hint: "mixed",
                        jp_odds: jpOdds,
                        rakeback: rakeback
                    })
                });

                const processingTime = Date.now() - startTime;

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${response.statusText} - ${errorText}`);
                }

                const results = await response.json();

                // プログレスバーを完了状態に
                completeProgress();

                // 成功をエラートラッキングに記録
                if (window.BetValueErrorTracker) {
                    window.BetValueErrorTracker.logEvent('analysis_completed', {
                        games_found: results.length,
                        processing_time: processingTime,
                        jp_odds: jpOdds,
                        rakeback: rakeback,
                        success: true
                    });
                }

                // 結果表示に切り替え（少し遅延を入れる）
                setTimeout(() => {
                    progressSection.style.display = 'none';
                    resultsDiv.style.display = 'block';
                    displayResults(results, processingTime);
                    resultsDiv.scrollIntoView({ behavior: 'smooth' });
                }, 500);

            } catch (error) {
                // エラーをエラートラッキングに記録
                if (window.BetValueErrorTracker) {
                    window.BetValueErrorTracker.logError('Analysis failed', {
                        error_message: error.message,
                        text_length: text.length,
                        user_action: 'analyze_betting_text'
                    });
                }

                resultsDiv.innerHTML = `
                    <div class="form-section">
                        <div class="error">
                            <h3>❌ エラーが発生しました</h3>
                            <p><strong>エラー内容:</strong> ${error.message}</p>
                            <p><strong>対処方法:</strong>
                            <br>• テキスト形式を確認してください
                            <br>• サーバーが起動しているか確認してください
                            <br>• API Keyが正しく設定されているか確認してください</p>
                            <p><strong>エラーは自動的に報告されました。</strong></p>
                        </div>
                    </div>
                `;
            }
        }

        function displayResults(results, processingTime) {
            const resultsDiv = document.getElementById('results');
            const gameCount = results.length;
            const avgConfidence = gameCount > 0 ?
                (results.reduce((sum, game) => sum + (game.match_confidence || 0), 0) / gameCount * 100).toFixed(1) : 0;

            let html = `
                <div class="form-section">
                    <div class="results-summary">
                        <h3>📊 分析結果サマリー</h3>
                        <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                            <div class="stat-item">
                                <span>🎮</span>
                                <span><strong>${gameCount}</strong> ゲーム検出</span>
                            </div>
                            <div class="stat-item">
                                <span>⏱️</span>
                                <span>処理時間: <strong>${processingTime}ms</strong></span>
                            </div>
                            <div class="stat-item">
                                <span>🎯</span>
                                <span>平均信頼度: <strong>${avgConfidence}%</strong></span>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            if (gameCount === 0) {
                html += `
                    <div class="form-section">
                        <div style="text-align: center; color: #8b949e; padding: 20px;">
                            <h3>🤔 ゲームが検出されませんでした</h3>
                            <p>テキスト形式を確認するか、サンプルデータをお試しください。</p>
                        </div>
                    </div>
                `;
            }

            results.forEach((game, index) => {
                const evClass = getEVClass(game.ev_percentage);
                const evFormatted = formatEV(game.ev_percentage);
                const verdictClass = getVerdictClass(game.verdict);
                const verdictIcon = getVerdictIcon(game.verdict);

                html += `
                    <div class="game-card">
                        <div class="game-header">
                            <div class="game-teams">
                                <span>${game.team_a}</span>
                                <span class="vs">vs</span>
                                <span>${game.team_b}</span>
                            </div>
                            <div class="sport-badge">${(game.sport || 'Unknown').toUpperCase()}</div>
                        </div>

                        <div class="game-details">
                            <div class="detail-item">
                                <span class="detail-label">📊 JP Line:</span>
                                <span class="detail-value">${game.jp_line || 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">📈 Pinnacle Line:</span>
                                <span class="detail-value">${game.pinnacle_line || 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">🎯 Fair Odds:</span>
                                <span class="detail-value">${game.fair_odds || 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">⭐ Fav Team:</span>
                                <span class="detail-value">${game.fav_team || 'N/A'}</span>
                            </div>
                        </div>

                        <!-- 双方向ベッティング結果 -->
                        <div class="betting-analysis">
                            <h4 style="margin-bottom: 15px; color: #f0f6fc; font-size: 1.1rem;">📊 双方向ベッティング分析</h4>

                            <!-- 本命側 (Favorite) -->
                            <div class="team-betting-section" style="margin-bottom: 15px; padding: 15px; background: #0d1117; border-radius: 6px; border-left: 3px solid #f79000;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <h5 style="color: #f79000; margin: 0; font-size: 1rem;">⭐ 本命: ${game.fav_team || 'N/A'}</h5>
                                    <div class="verdict ${verdictClass}">
                                        <span>${verdictIcon}</span>
                                        <span>${game.verdict || 'N/A'}</span>
                                    </div>
                                </div>

                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 8px;">
                                    <div class="odds-item">
                                        <span style="color: #8b949e; font-size: 12px;">📈 Pinnacle</span>
                                        <span style="color: #f0f6fc; font-weight: bold;">${game.pinnacle_line || 'N/A'}</span>
                                    </div>
                                    <div class="odds-item">
                                        <span style="color: #8b949e; font-size: 12px;">🎌 日本式</span>
                                        <span style="color: #f0f6fc; font-weight: bold;">${game.jp_line || 'N/A'}</span>
                                    </div>
                                    <div class="odds-item">
                                        <span style="color: #8b949e; font-size: 12px;">🎯 Fair Odds</span>
                                        <span style="color: #f0f6fc; font-weight: bold;">${game.fair_odds || 'N/A'}</span>
                                    </div>
                                </div>

                                <div class="ev-value ${evClass}" style="font-size: 1.1rem;">
                                    <span>💰</span>
                                    <span>期待値: <strong>${evFormatted}%</strong></span>
                                    ${game.rakeback_applied > 0 ? `<span style="font-size: 0.85rem; color: #2ea043;">(+${(game.rakeback_applied * 100).toFixed(1)}% レーキバック)</span>` : ''}
                                </div>
                            </div>

                            ${game.ev_percentage_dog !== undefined && game.ev_percentage_dog !== null ? `
                                <!-- アンダードッグ側 (Underdog) -->
                                <div class="team-betting-section" style="padding: 15px; background: #0d1117; border-radius: 6px; border-left: 3px solid #2ea043;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                        <h5 style="color: #2ea043; margin: 0; font-size: 1rem;">🐕 アンダードッグ: ${game.underdog_team || (game.fav_team === game.team_a ? game.team_b : game.team_a)}</h5>
                                        <div class="verdict ${getVerdictClass(game.verdict_dog)}">
                                            <span>${getVerdictIcon(game.verdict_dog)}</span>
                                            <span>${game.verdict_dog || 'N/A'}</span>
                                        </div>
                                    </div>

                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 8px;">
                                        <div class="odds-item">
                                            <span style="color: #8b949e; font-size: 12px;">📈 Pinnacle</span>
                                            <span style="color: #f0f6fc; font-weight: bold;">${game.pinnacle_line_dog || 'N/A'}</span>
                                        </div>
                                        <div class="odds-item">
                                            <span style="color: #8b949e; font-size: 12px;">🎌 日本式</span>
                                            <span style="color: #f0f6fc; font-weight: bold;">${game.jp_line_dog || 'N/A'}</span>
                                        </div>
                                        <div class="odds-item">
                                            <span style="color: #8b949e; font-size: 12px;">🎯 Fair Odds</span>
                                            <span style="color: #f0f6fc; font-weight: bold;">${game.fair_odds_dog || 'N/A'}</span>
                                        </div>
                                    </div>

                                    <div class="ev-value ${getEVClass(game.ev_percentage_dog)}" style="font-size: 1.1rem;">
                                        <span>💰</span>
                                        <span>期待値: <strong>${formatEV(game.ev_percentage_dog)}%</strong></span>
                                        ${game.rakeback_applied > 0 ? `<span style="font-size: 0.85rem; color: #2ea043;">(+${(game.rakeback_applied * 100).toFixed(1)}% レーキバック)</span>` : ''}
                                    </div>
                                </div>
                            ` : ''}
                        </div>

                        <div class="confidence-section">
                            <div class="confidence-bar">
                                <div class="confidence-fill" style="width: ${(game.match_confidence || 0) * 100}%"></div>
                            </div>
                            <div class="confidence-text">
                                🔍 マッチング信頼度: ${Math.round((game.match_confidence || 0) * 100)}%
                            </div>
                        </div>

                        ${game.api_game_id ? `<div class="api-id">🔗 API Game ID: ${game.api_game_id}</div>` : ''}

                        ${debugMode ? `
                            <div class="debug-info">
                                <h4>🔧 Debug Information</h4>
                                <div class="json-view">${JSON.stringify(game, null, 2)}</div>
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            resultsDiv.innerHTML = html;
        }

        function getEVClass(ev) {
            if (!ev && ev !== 0) return 'ev-neutral';
            if (ev > 5) return 'ev-positive';
            if (ev > 2) return 'ev-positive';
            if (ev > 0) return 'ev-positive';
            if (ev < -2) return 'ev-negative';
            return 'ev-negative';
        }

        function getVerdictClass(verdict) {
            switch(verdict?.toLowerCase()) {
                case 'strong bet': return 'verdict-strong';
                case 'bet': return 'verdict-bet';
                case 'consider': return 'verdict-consider';
                case 'avoid': return 'verdict-avoid';
                default: return 'verdict-neutral';
            }
        }

        function formatEV(ev) {
            if (!ev && ev !== 0) return 'N/A';
            return ev > 0 ? `+${ev.toFixed(1)}` : ev.toFixed(1);
        }

        function getVerdictIcon(verdict) {
            switch(verdict?.toLowerCase()) {
                case 'strong bet': return '🔥';
                case 'bet': return '✅';
                case 'consider': return '🤔';
                case 'avoid': return '❌';
                default: return '❓';
            }
        }

        function clearAll() {
            document.getElementById('bettingText').value = '';
            document.getElementById('results').style.display = 'none';
        }

        function toggleDebug() {
            debugMode = !debugMode;
            const buttonText = document.getElementById('debugButtonText');
            buttonText.textContent = debugMode ? 'デバッグ表示OFF' : 'デバッグ表示ON';

            // 結果が表示されている場合は再描画
            const results = document.getElementById('results');
            if (results.style.display !== 'none') {
                // 最後の分析結果を再表示（実装簡略化のため、実際には再分析が必要）
                console.log(`Debug mode: ${debugMode ? 'ON' : 'OFF'}`);
            }
        }

        function loadSample() {
            document.getElementById('bettingText').value = sampleData;
        }

        // ショートカット: Ctrl+Enter で分析実行
        document.getElementById('bettingText').addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                analyze();
            }
        });

        // フォーカス時のプレースホルダー調整
        document.getElementById('bettingText').addEventListener('focus', function() {
            if (this.value === '') {
                this.placeholder = '貼り付けまたは入力してください... (Ctrl+Enterで分析実行)';
            }
        });

        document.getElementById('bettingText').addEventListener('blur', function() {
            this.placeholder = 'ベッティング情報を貼り付けてください...\n\n例:\n[ＭＬＢ] ヤンキース<2.0> ホワイトソックス\n[ＭＬＢ] ドジャース<1.5> パドレス  \n[ＭＬＢ] フィリーズ<1半8> マーリンズ\n\n複雑なハンディキャップフォーマット対応:\n• 0半2 → 0.75変換\n• 0/7 → 0.7変換  \n• 1半8 → 1.75変換';
        });

        // 初期化完了
        console.log('🎯 BetValue Finder Personal Edition loaded successfully!');
        // プログレスバー関連の関数
        function resetProgressBar() {
            const progressFill = document.getElementById('progressFill');
            const progressDetails = document.getElementById('progressDetails');
            const stages = ['parsing', 'api', 'matching', 'odds', 'ev', 'final'];

            progressFill.style.width = '0%';
            progressDetails.textContent = '分析を準備しています...';

            stages.forEach(stage => {
                const element = document.getElementById(`stage-${stage}`);
                element.classList.remove('active', 'completed');
            });
        }

        let progressInterval;
        function simulateProgress() {
            const stages = [
                { id: 'parsing', name: 'パース中...', duration: 500 },
                { id: 'api', name: 'API取得中...', duration: 2000 },
                { id: 'matching', name: 'マッチング中...', duration: 1000 },
                { id: 'odds', name: 'オッズ取得中...', duration: 3000 },
                { id: 'ev', name: 'EV計算中...', duration: 800 },
                { id: 'final', name: '最終化中...', duration: 300 }
            ];

            let currentStage = 0;
            const progressFill = document.getElementById('progressFill');
            const progressDetails = document.getElementById('progressDetails');

            function updateStage() {
                if (currentStage < stages.length) {
                    const stage = stages[currentStage];
                    const element = document.getElementById(`stage-${stage.id}`);

                    // 前のステージを完了状態に
                    if (currentStage > 0) {
                        const prevStage = stages[currentStage - 1];
                        const prevElement = document.getElementById(`stage-${prevStage.id}`);
                        prevElement.classList.remove('active');
                        prevElement.classList.add('completed');
                    }

                    // 現在のステージをアクティブ状態に
                    element.classList.add('active');

                    // プログレスバーを更新
                    const progress = ((currentStage + 1) / stages.length) * 100;
                    progressFill.style.width = `${progress}%`;

                    // 詳細テキストを更新
                    progressDetails.textContent = stage.name;

                    currentStage++;
                    setTimeout(updateStage, stage.duration);
                }
            }

            updateStage();
        }

        function completeProgress() {
            const stages = ['parsing', 'api', 'matching', 'odds', 'ev', 'final'];
            const progressFill = document.getElementById('progressFill');
            const progressDetails = document.getElementById('progressDetails');

            // 全ステージを完了状態に
            stages.forEach(stage => {
                const element = document.getElementById(`stage-${stage}`);
                element.classList.remove('active');
                element.classList.add('completed');
            });

            // プログレスバーを100%に
            progressFill.style.width = '100%';
            progressDetails.textContent = '✅ 分析完了！結果を表示中...';
        }

        console.log('💡 Enhanced Parser + Team Mapper (95.9%) + Pipeline Orchestrator ready');
        console.log('🚀 Press Ctrl+Enter to analyze or click the analyze button');
        console.log('⚙️ Rakeback & Progress Bar integrated');
    </script>
</body>
</html>